name: Lint Code Base

on:
  workflow_call:

jobs:
  detect-typescript-changes:
    runs-on: ubuntu-latest
    outputs:
      should-run: ${{ steps.check.outputs.should-run }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect TypeScript changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          base: ${{ github.event.before || 'HEAD~1' }}
          filters: |
            typescript:
              - 'src/checkout/**'
              - '.lint/biome.json'
              - '.github/workflows/lint.yml'

      - name: Set should-run output
        id: check
        run: |
          echo "should-run=${{ steps.filter.outputs.typescript }}" >> $GITHUB_OUTPUT

  lint-biome:
    name: Lint Checkout (Biome)
    needs: detect-typescript-changes
    if: needs.detect-typescript-changes.outputs.should-run == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Biome linter
        uses: github/super-linter@v4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DEFAULT_BRANCH: main
          VALIDATE_ALL_CODEBASE: false

          VALIDATE_TYPESCRIPT_ES: false
          VALIDATE_TYPESCRIPT_STANDARD: false

          VALIDATE_BIOME_LINT: true
          FIX_BIOME_LINT: true
          FIX_BIOME_FORMAT: true
          BIOME_CONFIG_FILE: ".lint/biome.json"

          FILTER_REGEX_INCLUDE: "src/checkout/.*"

  detect-go-changes:
    runs-on: ubuntu-latest
    outputs:
      should-run: ${{ steps.check.outputs.should-run }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect Go changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          base: ${{ github.event.before || 'HEAD~1' }}
          filters: |
            go:
              - 'src/catalog/**'
              - '.lint/.golangci.yml'
              - '.github/workflows/lint.yml'

      - name: Set should-run output
        id: check
        run: |
          echo "should-run=${{ steps.filter.outputs.go }}" >> $GITHUB_OUTPUT

  lint-go:
    name: Lint Catalog (Go)
    needs: detect-go-changes
    if: needs.detect-go-changes.outputs.should-run == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go environment
        uses: actions/setup-go@v5
        with:
          go-version: "1.23.0"

      - name: Download Go modules
        run: |
          cd src/catalog
          go mod download

      - name: Run Go linter
        uses: github/super-linter@v4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DEFAULT_BRANCH: main
          VALIDATE_ALL_CODEBASE: false

          VALIDATE_GO: true
          FIX_GO_MODULES: true
          LINTER_RULES_PATH: ".lint"
          GO_GOLANGCI_LINT_CONFIG_FILE: ".golangci.yml"

          FILTER_REGEX_INCLUDE: "src/catalog/.*"

  detect-java-changes:
    runs-on: ubuntu-latest
    outputs:
      cart: ${{ steps.filter.outputs.cart }}
      orders: ${{ steps.filter.outputs.orders }}
      ui: ${{ steps.filter.outputs.ui }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect Java service changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          base: ${{ github.event.before || 'HEAD~1' }}
          filters: |
            cart:
              - 'src/cart/**'
              - '.lint/checkstyle.xml'
              - '.github/workflows/lint.yml'
            orders:
              - 'src/orders/**'
              - '.lint/checkstyle.xml'
              - '.github/workflows/lint.yml'
            ui:
              - 'src/ui/**'
              - '.lint/checkstyle.xml'
              - '.github/workflows/lint.yml'

  lint-java-cart:
    name: Lint Cart (Checkstyle)
    needs: detect-java-changes
    if: needs.detect-java-changes.outputs.cart == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Checkstyle linter
        uses: github/super-linter@v4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DEFAULT_BRANCH: main
          VALIDATE_ALL_CODEBASE: false
          VALIDATE_JAVA: true
          LINTER_RULES_PATH: ".lint"
          JAVA_FILE_NAME: "checkstyle.xml"
          FILTER_REGEX_INCLUDE: "src/cart/.*"

  lint-java-orders:
    name: Lint Orders (Checkstyle)
    needs: detect-java-changes
    if: needs.detect-java-changes.outputs.orders == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Checkstyle linter
        uses: github/super-linter@v4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DEFAULT_BRANCH: main
          VALIDATE_ALL_CODEBASE: false
          VALIDATE_JAVA: true
          LINTER_RULES_PATH: ".lint"
          JAVA_FILE_NAME: "checkstyle.xml"
          FILTER_REGEX_INCLUDE: "src/orders/.*"

  lint-java-ui:
    name: Lint UI (Checkstyle)
    needs: detect-java-changes
    if: needs.detect-java-changes.outputs.ui == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Checkstyle linter
        uses: github/super-linter@v4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DEFAULT_BRANCH: main
          VALIDATE_ALL_CODEBASE: false
          VALIDATE_JAVA: true
          LINTER_RULES_PATH: ".lint"
          JAVA_FILE_NAME: "checkstyle.xml"
          FILTER_REGEX_INCLUDE: "src/ui/.*"
