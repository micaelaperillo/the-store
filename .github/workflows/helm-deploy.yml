name: Deploy to Kubernetes cluster with Helm

on:
  workflow_call:
    secrets:
      DOCKERHUB_USERNAME:
        required: true
      KUBECONFIG:
        required: true
      AWS_ACCESS_KEY_ID:
        required: true
      AWS_SECRET_ACCESS_KEY:
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Set up Docker
        uses: docker/setup-docker-action@v4

      - name: Set up Kubectl
        uses: azure/setup-kubectl@v4

      - name: Create kubeconfig file
        run: |
          echo "${{ secrets.KUBECONFIG }}" > ${{ github.workspace }}/kubeconfig
          chmod 600 ${{ github.workspace }}/kubeconfig

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Deploy services
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          KUBECONFIG: ${{ github.workspace }}/kubeconfig
        run: |
          cd the-store-chart

          helm dependency build

          kubectl get secret the-store-chart-ingress-nginx-admission -n default \
            -o jsonpath='{.data.ca}' | base64 --decode > webhook-ca.crt
          kubectl patch validatingwebhookconfiguration the-store-chart-ingress-nginx-admission \
            --type='json' \
            -p '[{"op":"replace","path":"/webhooks/0/clientConfig/caBundle","value":"'"$(cat ./webhook-ca.crt | base64 | tr -d '\n')"'" }]'

          helm upgrade --install the-store-chart . \
          --set cart.image.repository=$DOCKERHUB_USERNAME/the-store-cart \
          --set catalog.image.repository=$DOCKERHUB_USERNAME/the-store-catalog \
          --set checkout.image.repository=$DOCKERHUB_USERNAME/the-store-checkout \
          --set orders.image.repository=$DOCKERHUB_USERNAME/the-store-orders \
          --set ui.image.repository=$DOCKERHUB_USERNAME/the-store-ui \
          --set cart.image.tag=latest \
          --set catalog.image.tag=latest \
          --set checkout.image.tag=latest \
          --set orders.image.tag=latest \
          --set ui.image.tag=latest \
          --namespace default \
          --kubeconfig $KUBECONFIG \
          --create-namespace
