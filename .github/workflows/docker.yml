name: Build and Push Docker Images

on:
  workflow_call:
    secrets:
      DOCKERHUB_USERNAME:
        required: true
      DOCKERHUB_TOKEN:
        required: true
    outputs:
      images_built:
        description: "Whether any images were built and pushed"
        value: ${{ jobs.detect-changes.outputs.images_built }}

env:
  IMAGE_NAME: the-store

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      cart: ${{ steps.filter.outputs.cart }}
      catalog: ${{ steps.filter.outputs.catalog }}
      checkout: ${{ steps.filter.outputs.checkout }}
      load-generator: ${{ steps.filter.outputs.load-generator }}
      orders: ${{ steps.filter.outputs.orders }}
      ui: ${{ steps.filter.outputs.ui }}
      images_built: ${{ steps.check.outputs.images_built }}
    steps:
      - uses: actions/checkout@v4

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            cart:
              - 'src/cart/**'
            catalog:
              - 'src/catalog/**'
            checkout:
              - 'src/checkout/**'
            load-generator:
              - 'src/load-generator/**'
            orders:
              - 'src/orders/**'
            ui:
              - 'src/ui/**'

      - name: Check if any service changed
        id: check
        run: |
          if [[ "${{ steps.filter.outputs.cart }}" == "true" ]] || \
            [[ "${{ steps.filter.outputs.catalog }}" == "true" ]] || \
            [[ "${{ steps.filter.outputs.checkout }}" == "true" ]] || \
            [[ "${{ steps.filter.outputs.load-generator }}" == "true" ]] || \
            [[ "${{ steps.filter.outputs.orders }}" == "true" ]] || \
            [[ "${{ steps.filter.outputs.ui }}" == "true" ]]; then
            echo "images_built=true" >> $GITHUB_OUTPUT
          else
            echo "images_built=false" >> $GITHUB_OUTPUT
          fi

  build-push-cart:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.cart == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and Push Docker image for cart
        uses: docker/build-push-action@v5
        with:
          context: ./src/cart
          file: ./src/cart/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}-cart:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}-cart:${{ github.sha }}

  build-push-catalog:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.catalog == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and Push Docker image for catalog
        uses: docker/build-push-action@v5
        with:
          context: ./src/catalog
          file: ./src/catalog/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}-catalog:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}-catalog:${{ github.sha }}

  build-push-checkout:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.checkout == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and Push Docker image for checkout
        uses: docker/build-push-action@v5
        with:
          context: ./src/checkout
          file: ./src/checkout/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}-checkout:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}-checkout:${{ github.sha }}

  build-push-load-generator:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.load-generator == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and Push Docker image for load-generator
        uses: docker/build-push-action@v5
        with:
          context: ./src/load-generator
          file: ./src/load-generator/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}-load-generator:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}-load-generator:${{ github.sha }}

  build-push-orders:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.orders == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and Push Docker image for orders
        uses: docker/build-push-action@v5
        with:
          context: ./src/orders
          file: ./src/orders/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}-orders:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}-orders:${{ github.sha }}

  build-push-ui:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.ui == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and Push Docker image for ui
        uses: docker/build-push-action@v5
        with:
          context: ./src/ui
          file: ./src/ui/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}-ui:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}-ui:${{ github.sha }}
